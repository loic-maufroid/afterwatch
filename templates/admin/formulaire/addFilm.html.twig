{% extends 'baseAdmin.html.twig' %}

{% block title %} {{ parent() }} - Ajouter Film{% endblock %}

{% block body %}
<div class="bg-success">
{% for message in app.flashes('success') %}
    {{ message }}
{% endfor %}
</div>
<div class="bg-danger">
    {% for error in app.flashes('error') %}
        {{ error }}
    {% endfor %}
</div>
<section class="flex jcenter margintop">
    <div id="scrollform" class="jumbotron scrollform">

        <h2 class="textc">Ajouter un film</h2>

        <div id="selectedFilm" class="row">
            <div id="titre" class="col-lg-8"></div>
            <div id="director" class="col-lg-4"></div>
            <div id="affiche" class="col-lg-8"></div>
            <div id="date" class="col-lg-4"></div>
        </div>

        {{ form_start(form) }}

        <div class="form-group">
            <!--<input type="file" class="form-control-file" id="inputAffiche">-->
            {{ form_row(form.affiche) }}
        </div>
        <div class="form-row">
            <div class="form-group col-md-6">
                <!--<label for="inputTitre">Titre</label>
                <input type="text" class="form-control" id="inputTitre" placeholder="Titre">-->
                {{ form_row(form.titre) }}
            </div>
            <div class="form-group col-md-6 invisible">
                <!--<label for="inputDate">Date de sortie</label>
                <input type="text" class="form-control" id="inputDate" placeholder="Date de sortie">-->
                {{ form_row(form.date) }}
            </div>
        </div>
            <div class="form-group  col-md-6">
                <!--<label for="inputReal">Réalisateur(s)</label>
                <input type="hidden" class="form-control" id="inputReal" placeholder="Réalisateur(s)">
                -->
            </div>
            <div class="form-group  col-md-6">
                <!--<label for="inputScénariste">Scénariste(s)</label>
                <input type="hidden" class="form-control" id="inputScénariste" placeholder="Scénariste(s)">
                -->
            </div>
            <div class="form-group  col-md-6">
                <!--<label for="inputActeurs">Acteur(s)</label>
                <input type="hidden" class="form-control" id="inputAct" placeholder="Acteur(s)">
                -->{{ form_row(form.act) }}
            </div>
            <div class="form-group  col-md-6">
                <!--<label for="inputGenre">Genre(s)</label>
                <input type="hidden" class="form-control" name="inputGenre" id="inputGenre" placeholder="Genre(s)">-->
                {{ form_row(form.genre) }}
            </div>
        <div class="form-row">
            <div class="form-group col-md-6">
                <!--<label for="inputDurée">Durée(s)</label>
                <input type="text" class="form-control" id="inputDurée" placeholder="Durée(s)">-->
                {{ form_row(form.duree) }}
            </div>
            <div class="form-group col-md-6">
                <!--<label for="inputNationnalité">Nationnalité(s)</label>
                <input type="text" class="form-control" id="inputNationnalité"  placeholder="Nationnalité(s)">-->
                {{ form_row(form.nationalite) }}
            </div>
        </div> 
        <div class="form-row">
            <div class="form-group col-md-6">
                <!--<label for="inputCNC">Limite d'âge</label>
                <input type="text" class="form-control" id="inputCNC" placeholder="Age requis">-->
                {{ form_row(form.legislation) }}
            </div>
            <div class="form-group col-md-6">
                <!--<label for="inputBA">Bande-annonce</label>
                <input type="text" class="form-control" id="inputBA"  placeholder="URL">-->
                {{ form_row(form.trailer) }}
            </div>
        </div> 
        <div class="form-group">
            <!--<label for="inputSynopsis">Synopsis</label>
            <textarea type="text" class="form-control" id="inputSynopsis" placeholder="Synopsis"></textarea>-->
            {{ form_row(form.synopsis) }}
        </div>
        <div class="flex jcenter margintop">
            <a href="{{ path('admin') }}"><button type="button" class="btn btn-danger btnsup">Annuler</button></a>
            <button type="submit" id="submitFilm" class="btn btn-success marginr">Valider</button>
        </div>    
    
    {{ form_end(form) }}


    <button id="boutonPopu" formnovalidate>Faire la recherche</button>
    <h4 class="danger" id="messageRecherche"></h4>

    <div id="selection-films">
    <table class="table table-bordered" id="infos">
    </table>
    <!--<div id="titre"></div>
    <div id="affiche"></div>
    <div id="genres"></div>
    <div id="synopsis"></div>
    <div id="date"></div>
    <div id="duree"></div>
    <div id="nationalite"></div>
    <div id="trailer"></div>
    <div id="reals"></div>
    <div id="acts"></div>
    <div id="scens"></div>-->
    </div>
    </div>
<!--</section>-->
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
$("#submitFilm").hide();

var films = [];
var curEntry = [];
var selected = -1;

$("#boutonPopu").click(function(event){
    event.preventDefault();
    $("#messageRecherche").text("");
    $("#infos thead").remove();
    $("#infos tbody").remove();
    films = [];
    curEntry = [];
    $("#infos").append("<thead class='thead-info'><tr><th scope='col'>Titre</th><th scope='col'>Date de sortie</th><th scope='col'>Genre(s)</th><th scope='col'>Affiche</th><th scope='col'>Réalisateur(s)</th><th>Actions</th></tr></thead><tbody></tbody>");
    var query = $("#film_titre").val();
    if (query.trim().length > 0){

    $.ajax({
            type : 'GET',
            url : "https://api.themoviedb.org/3/search/movie?language=fr&api_key=7024fabede73fed68005e5a632136b71&query="+query,
            dataType : 'JSON',
        success: function(response){

            console.log(response);

           if (response.results.length > 0){
            
            var resultats = response.results;

            for(let i=0;i<resultats.length;i++){
                
                titre = resultats[i].title;
                synopsis = resultats[i].overview;
                dateFilm = resultats[i].release_date;
                idFilm = resultats[i].id;
                
                films.push([idFilm,titre,synopsis,dateFilm]);
            }

           for([indice,film] of films.entries()){

           $("#infos tbody").append("<tr><td></td><td></td><td></td><td></td><td></td><td></td></tr>");
           curEntry[indice] = [$("#infos tbody tr:nth-child("+(indice+1)+")"),film];

           }

           for (i=0;i<curEntry.length;i++){

           curEntry[i][0].children("td:first-child").text(curEntry[i][1][1]);
           
           
           if (curEntry[i][1][3])
           curEntry[i][0].children("td:nth-child(2)").text(curEntry[i][1][3]);

           }
           //console.log(curEntry.children());
           //var date = dateFilm;
           
           //$("#film_date").val(new Date(date).toISOString().substring(0,10));
           
           for(i=0;i<curEntry.length;i++){
           detailsFilm(i); 
           }

           for(i=0;i<curEntry.length;i++){
               trailerFilm(i);
           }

           for(i=0;i<curEntry.length;i++){
               creditsFilm(i);     
            }
           
           for(i=0;i<curEntry.length;i++){
               curEntry[i][0].children().last().append("<button type='button' class='selection btn btn-primary' value='"+i+"'>Sélectionner</button>");
           }
           
           $(".selection").click(function(e){
           
           var numero = $(this).val();
           selected = numero;
           curEntry[numero][0].css("border","solid");
           curEntry[numero][0].toggleClass("border-primary");
           $(".selection").toggle();
           curEntry[numero][0].children().last().append("<button type='button' class='deselection btn btn-danger' value='"+numero+"'>Déselectionner</button>");
           $("label").hide();
           $("input").hide();
           $("#boutonPopu").hide();
           $("#submitFilm").show();
           $("#titre").html("<h4>"+curEntry[numero][1][1]+"</h4>");
           $("#affiche").html("<img src='http://image.tmdb.org/t/p/w185/"+curEntry[numero][1][6]+"'>");
           $("#date").html("<p>sorti le "+curEntry[numero][1][3]+"</p>");
           $("#director").html("<p> de "+curEntry[numero][1][9].split('+').join('/')+"</p>");

           $("#film_titre").val(curEntry[numero][1][1]);
           $("#film_date").val(new Date(curEntry[numero][1][3]).toISOString().substring(0,10));
           $("#film_synopsis").val(curEntry[numero][1][2]);
           $("#film_act").val(curEntry[numero][1][11]);
           $("#film_genre").val(curEntry[numero][1][4]);
           $("#film_duree").val(curEntry[numero][1][5]);
           $("#film_nationalite").val(curEntry[numero][1][7]);
           $("#film_real").val(curEntry[numero][1][9]);
           $("#film_scen").val(curEntry[numero][1][10]);
           $("#film_trailer").val(curEntry[numero][1][8]);
           $("#film_affiche").val(curEntry[numero][1][6]);
           
           $('#scrollform').animate({
                    scrollTop: 0
                }, 2000);

           $(".deselection").click(function(e){
               selected = -1;
               $("#selectedFilm *").html("");
               $("label").show();
               $("input").show();
               $("#boutonPopu").show();
               $("#submitFilm").hide();
               var index = $(this).val();
               curEntry[index][0].css("border","inherit");
               curEntry[index][0].toggleClass("border-primary");
               $(".deselection").remove();
               $(".selection").toggle();
           });
           });
           }
           else
           $("#messageRecherche").text("Pas de résultats.Vérifiez l'expression en recherche et réessayez."); 
  
           
    }
    }         
    );
    }
    else
    $("#messageRecherche").text("Saisissez un nom de film");
    
});



function detailsFilm(i){

    $.ajax({
               type : 'GET',
               url : "https://api.themoviedb.org/3/movie/"+curEntry[i][1][0]+"?api_key=7024fabede73fed68005e5a632136b71&language=fr",
               dataType : 'JSON',
               success: function(response){
                
                console.log(i);
                
                   if (response.genres.length > 0){
                   var genresFilm = response.genres[0].name; 
                   for (let indice = 1; indice < response.genres.length; indice++) {
                       genresFilm += "+"+response.genres[indice].name;
                   }
                   curEntry[i][1].push(genresFilm);
                   curEntry[i][0].children("td:nth-child(3)").text(genresFilm.split('+').join('-'));
               }
               else
               curEntry[i][1].push(null);

               console.log(curEntry[i][0]);
                   
                   
                   if(response.runtime){
                   //curEntry[i][0].children().last().text(Math.floor(response.runtime / 60)+"h"+(response.runtime % 60)+"mn");
                   curEntry[i][1].push(response.runtime);
                   }
                   else
                   curEntry[i][1].push(null);

                   if (response.poster_path){
                   curEntry[i][1].push(response.poster_path);
                   curEntry[i][0].children("td:nth-child(4)").append("<img src='http://image.tmdb.org/t/p/w185/"+response.poster_path+"'>");
                   }
                   else
                   curEntry[i][1].push(null);


                   if (response.original_language){
                   curEntry[i][1].push(response.original_language);
                   //curEntry[i][0].children().last().text(response.original_language);
                   }
                   else
                   curEntry[i][1].push(null);

                }
           })
}

function trailerFilm(i){
    $.ajax({
                       type : 'GET',
                       url : "https://api.themoviedb.org/3/movie/"+curEntry[i][1][0]+"/videos?api_key=7024fabede73fed68005e5a632136b71&language=fr",
                       dataType : 'JSON',
                       success: function(response){
                           //console.log(response);

                           if (response.results.length > 0){
                           curEntry[i][1].push(response.results[0].key);
                           //curEntry[i][0].children().last().append("<a href='https://youtube.com/watch/"+response.results[0].key+"'>Lien vers la bande-annonce</a>");
                           }
                           else
                           curEntry[i][1].push(null);
                       }
    });

}

function creditsFilm(i){
   

                           $.ajax({
                               type : 'GET',
                               url : 'https://api.themoviedb.org/3/movie/'+curEntry[i][1][0]+'/credits?api_key=7024fabede73fed68005e5a632136b71',
                               dataType : 'JSON',
                               success: function(response){

                                   var dirsFilm = "";
                                   
                                   var actsFilm = "";
                                   
                                   var scensFilm = "";
                                   
                                  for (let k = 0; k < response.crew.length; k++) {
                                      if (response.crew[k].job == "Director"){
                                         dirsFilm += response.crew[k].name+"+";
                                      }
                                      if (response.crew[k].department == "Writing"){
                                         scensFilm += response.crew[k].name+"+";
                                      }
                                  }
                                  for (let j = 0; j < response.cast.length; j++) {
                                      if (j == 5)
                                      break;
                                      actsFilm += response.cast[j].name+"+";
                                  }
                                  if (dirsFilm.length > 0)
                                  dirsFilm = dirsFilm.substring(0,dirsFilm.length-1);

                                  if (actsFilm.length > 0)
                                  actsFilm = actsFilm.substring(0,actsFilm.length-1);

                                  if (scensFilm.length > 0)
                                  scensFilm = scensFilm.substring(0,scensFilm.length-1);

                                  /*console.log(dirsFilm);
                                  console.log(scensFilm);
                                  console.log(actsFilm);*/

                                  curEntry[i][0].children("td:nth-child(5)").text(" "+dirsFilm.split('+').join('/'));
                                  /*curEntry[i][0].append("<td></td>");
                                  curEntry[i][0].children().last().text(" "+scensFilm.split('+').join('/'));
                                  curEntry[i][0].append("<td></td>");
                                  curEntry[i][0].children().last().text(" "+actsFilm.split('+').join('/'));*/

                                  //console.log(curEntry);
                                  
                                  curEntry[i][1].push(dirsFilm);
                                  curEntry[i][1].push(scensFilm);
                                  curEntry[i][1].push(actsFilm);

                               }
                           });
}

</script>
{% endblock %}


